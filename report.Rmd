---
title: "STRIDE Dashboard Report"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
params:
  data: NA
  metrics: NA
  state: NA
  metric_names: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(dplyr)
library(plotly)
library(htmltools) # Required for structuring the report
```

### Report Details

**Drill-down Level:** `r params$state$level`


```{r generate_plots, results='asis'}
# --- GLOBAL MISSING DATA TERMS (UPDATED) ---
MISSING_TERMS <- c("n/a", "na", "not available", "blank", "none", "no data", "unspecified", "others", "total", "grand total", "sum", "", "<not available>")

# --- HELPER: UNIVERSAL DATA FINDER ---
get_metric_data <- function(data, target_metric, metric_list) {
  clean_str <- function(x) { tolower(gsub("[. ]", "", x)) }
  target_clean <- clean_str(target_metric)
  
  matched_data <- data %>% filter(sapply(Metric, clean_str) == target_clean)
  if(nrow(matched_data) > 0) return(matched_data)
  
  pretty_name <- names(metric_list)[metric_list == target_metric]
  if(length(pretty_name) > 0) {
    pretty_clean <- clean_str(pretty_name)
    matched_data <- data %>% filter(sapply(Metric, clean_str) == pretty_clean)
    if(nrow(matched_data) > 0) return(matched_data)
  }
  return(matched_data)
}

# --- HELPER: FORMAT LIST FOR SENTENCES ---
format_top_list <- function(df) {
  if(nrow(df) == 0) return("None")
  
  df$Category <- as.character(df$Category)
  
  items <- paste0("<b>", df$Category, "</b> (", format(df$Value, big.mark=","), ")")
  
  if (length(items) > 1) {
    last <- items[length(items)]
    rest <- items[-length(items)]
    return(paste(paste(rest, collapse=", "), "and", last))
  } else {
    return(items)
  }
}

# --- 1. GENERATE EXECUTIVE SUMMARY ---

summary_sentences <- list()
summary_sentences[[1]] <- HTML("This executive summary highlights the key findings from the selected data metrics, focusing on the highest recorded values for each category. ")

for (m in params$metrics) {
  clean_name <- names(params$metric_names)[params$metric_names == m]
  if(length(clean_name) == 0) clean_name <- m
  
  dat <- get_metric_data(params$data, m, params$metric_names)
  
  if (nrow(dat) > 0) {
    # Apply filtering for summary
    dat_clean_summ <- dat %>%
      filter(!is.na(Category) & trimws(Category) != "") %>%
      filter(!tolower(trimws(Category)) %in% MISSING_TERMS)
      
    top_row <- dat_clean_summ %>% 
      arrange(desc(Value)) %>% slice(1)
      
    if(nrow(top_row) == 0) top_row <- dat %>% arrange(desc(Value)) %>% slice(1)
    
    val_formatted <- format(top_row$Value, big.mark=",")
    
    current_sentence <- HTML(paste0(
      "Regarding <b>", clean_name, "</b>, the highest figure was observed in <b>", top_row$Category, 
      "</b> with a total of <b>", val_formatted, "</b>. "
    ))
    summary_sentences[[length(summary_sentences) + 1]] <- current_sentence
  }
}

summary_paragraph <- do.call(tagList, summary_sentences)

summary_section <- tags$div(
  style = "background-color: #f8f9fa; border-left: 5px solid #003366; padding: 20px; margin-bottom: 30px; border-radius: 5px; line-height: 1.6; font-size: 1.05rem; color: #333;",
  h3("Executive Summary", style="margin-top:0; color: #003366; margin-bottom: 15px;"),
  tags$p(summary_paragraph, style="margin-bottom: 0;")
)


# --- 2. GENERATE GRAPHS WITH DETAILED ANALYSIS ---

graph_list <- list()

for (i in seq_along(params$metrics)) {
  
  current_metric <- params$metrics[[i]]
  clean_name <- names(params$metric_names)[params$metric_names == current_metric]
  if(length(clean_name) == 0) clean_name <- m

  # 1. Get Base Data
  plot_data <- get_metric_data(params$data, current_metric, params$metric_names)

  if (nrow(plot_data) == 0) {
    graph_list[[i]] <- tagList(
      h3(clean_name),
      p(em("No data available for this selection.")),
      hr()
    )
    next
  } else {
    
    # === MISSING DATA FILTER ===
    # Filter out categories that are NA, empty, or represent missing data.
    plot_data_clean <- plot_data %>% 
      filter(!is.na(Category) & trimws(Category) != "") %>%
      filter(!tolower(trimws(Category)) %in% MISSING_TERMS)
      
    if (nrow(plot_data_clean) == 0) {
      graph_list[[i]] <- tagList(
        h3(clean_name),
        p(em("No valid data points remain after filtering missing categories.")),
        hr()
      )
      next # Skip plotting if no valid data remains
    }
    
    # --- A. Generate Top 3 / Bottom 3 Analysis & Calculate Total ---
    
    # Calculate the total based on the CLEAN data
    total_val <- sum(plot_data_clean$Value, na.rm=TRUE)

    # --- NEW LOGIC FOR ANALYSIS NARRATIVE ---
    if (total_val == 0) {
        description_text <- paste0(
            "The chart above illustrates the distribution for <b>", clean_name, "</b>. ",
            "The total recorded count across all displayed categories is **0**. ",
            "No positions were recorded for any of the categories at this drill-down level."
        )
    } else {
        # Use plot_data_clean for analysis
        top_3_df <- plot_data_clean %>% 
            arrange(desc(Value)) %>% 
            head(3)
        
        bottom_3_df <- plot_data_clean %>% 
            arrange(Value) %>% 
            head(3)
        
        # Construct Narrative in paragraph form
        description_text <- paste0(
            "The chart above illustrates the distribution for <b>", clean_name, "</b>. ",
            "The total recorded count across all displayed categories is <b>", format(total_val, big.mark=","), "</b>. ",
            "A detailed look at the breakdown shows the <b>highest 3</b> areas are: ", 
            format_top_list(top_3_df), ". ",
            "Conversely, the <b>lowest 3</b> areas are: ", 
            format_top_list(bottom_3_df), "."
        )
    }
    # --- END OF NEW LOGIC ---
    
    # --- B. Prepare Data for Plotting ---
    
    # 1. Add "TOTAL" Row (This row is separate from plot_data_clean)
    total_row <- data.frame(
      Category = "TOTAL", 
      Value = total_val, 
      Metric = current_metric, 
      stringsAsFactors = FALSE
    )
    
    # Combine the *clean* data with the synthetic TOTAL row
    plot_data_final <- dplyr::bind_rows(plot_data_clean, total_row)
    
    # 2. Set Factor Levels (TOTAL at bottom, then Descending up to top)
    sorted_cats_asc <- plot_data_clean %>% arrange(Value) %>% pull(Category)
    final_levels <- c("TOTAL", as.character(sorted_cats_asc)) # Ensure factor levels are character
    plot_data_final$Category <- factor(plot_data_final$Category, levels = final_levels)
    
    # --- C. Generate Plot (Numbers Outside & Smaller Range Buffer) ---
    # Adjust max range if total is zero to prevent large empty space
    max_range <- if (total_val == 0) 1 else (max(plot_data_final$Value, na.rm=TRUE) * 1.25)
    
    p <- plot_ly(
      data = plot_data_final,
      y = ~Category,
      x = ~Value,
      type = 'bar',
      orientation = 'h',
      marker = list(color = '#003366'),
      text = ~format(Value, big.mark = ","), 
      textposition = 'outside',            
      cliponaxis = FALSE                   
    ) %>%
      layout(
        title = "",
        xaxis = list(
          title = "Value", 
          range = c(0, max_range) 
        ),
        yaxis = list(title = "")
      )
    
    # --- D. Combine into Section ---
    graph_list[[i]] <- tagList(
      h3(clean_name, style="margin-top: 30px; color: #003366;"), 
      p,                                                         
      tags$div(                                                  
        style="margin-top: 15px; padding: 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; color: #555;",
        tags$b("Analysis:"), HTML(description_text)
      ),
      hr(style="margin-top: 30px; border-top: 2px solid #eee;")  
    )
  }
}

# --- 3. FINAL OUTPUT ---
tagList(
  summary_section, 
  graph_list
)
```