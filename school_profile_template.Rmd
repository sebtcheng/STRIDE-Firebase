---
title: "School Profile Datasheet"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    theme: paper
    highlight: tango
    css: null
params:
  school_name: "School Name Placeholder"
  df_basic: NA
  df_enrol: NA
  df_teachers: NA
  df_infra: NA
  df_spec: NA
---

<style>
  /* Infosheet Custom Styling */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9f9f9;
    color: #333;
  }
  h1.title {
    display: none; /* Hide default title to use custom header */
  }
  .header-panel {
    background-color: #003366;
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
    margin-bottom: 20px;
  }
  .header-panel h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
  }
  .header-panel p {
    margin: 5px 0 0 0;
    opacity: 0.8;
    font-size: 14px;
  }
  h3 {
    color: #2c3e50;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 18px;
    font-weight: 700;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }
  .info-card h3:first-child {
    margin-top: 0;
  }
  .info-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    border: 1px solid #e1e4e8;
  }
  table {
    width: 100%;
    margin-bottom: 15px !important;
    font-size: 14px;
  }
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: #f8f9fa;
  }
  .highlight-box {
    text-align: center;
    padding: 10px;
    background-color: #f0f4f8;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid #dbe2e8;
  }
  .highlight-stat {
    display: block;
    font-size: 1.4em;
    font-weight: bold;
    color: #003366;
  }
  .highlight-label {
    font-size: 0.85em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .footer {
    text-align: center;
    color: #999;
    font-size: 12px;
    margin-top: 30px;
    border-top: 1px solid #eee;
    padding-top: 15px;
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(knitr)
library(dplyr)

render_info_table <- function(df, exclude_metrics = c()) {
  if (is.null(df) || !is.data.frame(df) || nrow(df) == 0) {
    cat("<p style='color:#777; font-style:italic; font-size:13px;'>No data available.</p>")
    return(NULL)
  }
  clean_df <- df %>%
    filter(!Metric %in% exclude_metrics) %>%
    filter(!is.na(Value), Value != "0", Value != "N/A", Value != "") %>%
    select(Metric, Value)
  if (nrow(clean_df) == 0) {
    cat("<p style='color:#777; font-style:italic; font-size:13px;'>No specific records found.</p>")
    return(NULL)
  }
  print(kable(clean_df, col.names = NULL, format = "html", 
              table.attr = "class='table table-striped table-sm'", 
              escape = FALSE))
}

get_val <- function(df, key) {
  if (is.null(df) || !is.data.frame(df)) return(NULL)
  row <- df %>% filter(Metric == key)
  if(nrow(row) == 0) return(NULL)
  val <- row$Value[1]
  if (is.na(val) || val == "0" || val == "N/A" || val == "") return(NULL)
  return(val)
}
```

<div class="header-panel">
  <h1>`r params$school_name`</h1>
  <p>STRIDE System Profile | Generated: `r format(Sys.time(), '%B %d, %Y')`</p>
</div>

<div class="row"><div class="col-md-12"><div class="info-card">

### <i class="glyphicon glyphicon-map-marker"></i> Basic Information & Location

```{r, results='asis'}
df <- params$df_basic
if (!is.null(df) && nrow(df) > 0) {
  target_order <- c(
    "School ID", "School Head", "Position", "Typology",
    "Curricular Offering", "Region", "Division",
    "Municipality", "Barangay"
  )
  display_df <- df %>%
    filter(Metric %in% target_order) %>%
    mutate(Metric = factor(Metric, levels = target_order)) %>%
    arrange(Metric)
  render_info_table(display_df)
} else {
  cat("<p>No basic profile data available.</p>")
}
```

### <i class="glyphicon glyphicon-user"></i> Enrolment
<div class="highlight-box">
  <span class="highlight-label">Total Learners</span>
  <span class="highlight-stat">`r val <- get_val(params$df_enrol, "Total Enrolment"); if(is.null(val)) "-" else val`</span>
</div>

```{r, results='asis'}
render_info_table(params$df_enrol, exclude_metrics = c("Total Enrolment"))
```

### <i class="glyphicon glyphicon-education"></i> Teachers
<div class="highlight-box">
  <span class="highlight-label">Total Teachers</span>
  <span class="highlight-stat">`r val <- get_val(params$df_teachers, "Total Teachers"); if(is.null(val)) "-" else val`</span>
</div>

```{r, results='asis'}
render_info_table(params$df_teachers, exclude_metrics = c("Total Teachers"))
```

### <i class="glyphicon glyphicon-home"></i> Infrastructure
```{r, results='asis'}
render_info_table(params$df_infra, exclude_metrics = c("Total Buildings", "Total Classrooms", "Estimated Shortage"))
```

</div></div></div>

<div class="row"><div class="col-md-12"><div class="info-card">
### <i class="glyphicon glyphicon-book"></i> Specialization (JHS/SHS)

```{r, results='asis'}
render_info_table(params$df_spec)
```

</div></div></div>

<div class="footer">
  <p><strong>STRIDE Dashboard</strong></p>
</div>
